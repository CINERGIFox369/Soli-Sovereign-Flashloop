name: "ğŸ”’ Security Audit & Compliance"

on:
  push:
    branches: [main, master, develop]
    paths:
      - "**/Cargo.toml"
      - "**/Cargo.lock"
      - "**/*.rs"
      - "**/Dockerfile"
      - ".github/workflows/**"

  pull_request:


jobs:

  secrets-scan:
    name: "ğŸ” Secrets + Dependency Vulnerability Scan"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "âš ï¸ No Node project found, skipping npm install."
          fi

      - name: Run npm audit
        run: |
          if [ -f package-lock.json ]; then
            echo "ğŸ” Running npm audit..."
            npm audit --audit-level=high || true
            npm audit --audit-level=moderate --json > audit-results.json || true
          else
            echo "âœ… No npm dependencies present."
          fi

      - name: Upload npm audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: audit-results.json
          retention-days: 30



  container-security:
    name: "ğŸ³ Container + Gitleaks Security Scan"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Gitleaks scan
        uses: zricethezav/gitleaks-action@v8
        with:
          args: --path=. --verbose



  trufflehog_scan:
    name: "ğŸ¦Š TruffleHog Verified Secrets Scan"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified



  vulnerability-audit:
    name: "ğŸ§¾ Rust Vulnerability + License Audit"
    runs-on: ubuntu-latest
    needs: [container-security, secrets-scan]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Create deny.toml if missing
        run: |
          if [ ! -f deny.toml ]; then
            echo "ğŸ“Œ deny.toml missing â€” generating default license policy..."

            printf '%s\n' \
              '[licenses]' \
              'allow = [' \
              '  "MIT",' \
              '  "Apache-2.0",' \
              '  "Apache-2.0 WITH LLVM-exception",' \
              '  "BSD-2-Clause",' \
              '  "BSD-3-Clause",' \
              '  "ISC",' \
              '  "Unicode-DFS-2016",' \
              ']' \
              '' \
              'deny = [' \
              '  "GPL-2.0",' \
              '  "GPL-3.0",' \
              '  "AGPL-3.0",' \
              ']' \
              '' \
              '[bans]' \
              'multiple-versions = "warn"' \
              'wildcards = "deny"' \
              > deny.toml

            echo "âœ… deny.toml created successfully"
          else
            echo "âœ… deny.toml already present"
          fi

      - name: Install Security Tools
        run: |
          cargo install cargo-audit --locked || true
          cargo install cargo-deny --locked || true

      - name: Run Cargo Audit (Vulnerabilities)
        run: |
          echo "ğŸ” Running Rust vulnerability scan..."
          cargo audit --color=always || true
          cargo audit --format=json > audit-report.json || true
          cargo audit --format=markdown > audit-report.md || true

      - name: Run Cargo Deny (Licenses + Bans)
        run: |
          echo "ğŸ” Running cargo-deny license + ban checks..."
          cargo deny check licenses || true
          cargo deny check bans || true

      - name: Upload Rust Audit Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rust-security-audit
          path: |
            audit-report.json
            audit-report.md
            deny.toml
          retention-days: 30



  compliance-check:
    name: "ğŸ“‹ Compliance Validation"
    runs-on: ubuntu-latest
    needs: [vulnerability-audit]
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dockerfile Security Validation
        run: |
          echo "ğŸ”’ Validating Dockerfile security..."

          if [ -f Dockerfile ]; then

            if ! grep -q "^USER" Dockerfile; then
              echo "âŒ Dockerfile should specify a non-root USER"
              exit 1
            fi

            if grep -q "COPY.*\*" Dockerfile; then
              echo "âš ï¸ Avoid COPY wildcards in production builds"
            fi

            echo "âœ… Dockerfile validation passed"

          else
            echo "âš ï¸ No Dockerfile found, skipping compliance check."
          fi



  security-report:
    name: "ğŸ“Š Unified Security Report"
    runs-on: ubuntu-latest
    needs:
      - secrets-scan
      - container-security
      - trufflehog_scan
      - vulnerability-audit
      - compliance-check
    if: always()

    steps:
      - name: Generate Security Summary
        run: |
          echo ""
          echo "ğŸ”’ SECURITY AUDIT SUMMARY"
          echo "===================================="
          echo "Date: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""

          echo "âœ… Secrets Scan:        ${{ needs.secrets-scan.result }}"
          echo "âœ… Container Security:  ${{ needs.container-security.result }}"
          echo "âœ… TruffleHog Scan:     ${{ needs.trufflehog_scan.result }}"
          echo "âœ… Vulnerability Audit: ${{ needs.vulnerability-audit.result }}"
          echo "âœ… Compliance Check:    ${{ needs.compliance-check.result }}"
          echo ""

          if [[ "${{ needs.secrets-scan.result }}" == "success" && \
                "${{ needs.container-security.result }}" == "success" && \
                "${{ needs.trufflehog_scan.result }}" == "success" && \
                "${{ needs.vulnerability-audit.result }}" == "success" && \
                "${{ needs.compliance-check.result }}" == "success" ]]; then

            echo "ğŸ‰ ALL SECURITY CHECKS PASSED"

          else

            echo "ğŸš¨ SECURITY ISSUES DETECTED â€” REVIEW REQUIRED"

          fi

          echo "===================================="
