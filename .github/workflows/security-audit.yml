name: ðŸ”’ Security Audit & Compliance

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  push:
      branches: [ main, master, develop ]
      paths:
      - '**/Cargo.toml'
      - '**/Cargo.lock'
      - '**/*.rs'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - '**/Cargo.toml'
      - '**/Cargo.lock'
      - '**/*.rs'
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose output'
        required: false
        default: 'false'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  dependency-security:
    name: ðŸ›¡ï¸ Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          echo "ðŸ” Scanning for vulnerable dependencies..."
          npm audit --audit-level=high
          npm audit --audit-level=moderate --json > audit-results.json || true

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results
          path: audit-results.json
          retention-days: 30

  container-security:
    name: ðŸ³ Container Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image for scanning
        run: |
          docker build -t soli-security-scan:latest .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'soli-security-scan:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

secrets-scan: 
  name: ðŸ” Secrets Detection 
  runs-on: ubuntu-latest 
  
  steps: 
      - name: Checkout code 
        uses: actions/checkout@v4 
        with: 
          fetch-depth: 0
        
trufflehog_scan:
    name: Scan for Secrets with TruffleHog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set BASE and HEAD commits
        id: commits
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "BASE=${{ github.event.before }}" >> $GITHUB_OUTPUT
            echo "HEAD=${{ github.sha }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "BASE=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
            echo "HEAD=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          else
            echo "BASE=" >> $GITHUB_OUTPUT
            echo "HEAD=" >> $GITHUB_OUTPUT
          fi
      
      - name: Run TruffleHog (CLI) scan
        if: ${{ steps.commits.outputs.BASE && steps.commits.outputs.HEAD && steps.commits.outputs.BASE != steps.commits.outputs.HEAD }}
        env:
          BASE: ${{ steps.commits.outputs.BASE }}
          HEAD: ${{ steps.commits.outputs.HEAD }}
          TRUFFLEHOG_GITHUB_API_KEY: ${{ secrets.GITHUB_TOKEN }}
        run: |
         npx trufflehog github --since-commit "$BASE" --branch "$HEAD" --fail --no-update --github-actions

      - name: Run TruffleHog action
        uses: trufflesecurity/trufflehog@main
        with:
        path: ./
        base: ${{ steps.commits.outputs.BASE }}
        head: ${{ steps.commits.outputs.HEAD }}
        extra_args: --debug --only-verified

      - name: Run Gitleaks scan
        uses: zricethezav/gitleaks-action@v8
        with:
        args: --path=. --verbose
        # Adjust gitleaks args/config as needed (or add a config file)


      - name: Run GitLeaks scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

compliance-check:
       name: ðŸ“‹ Compliance Validation
       runs-on: ubuntu-latest
       steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Validate Docker security
          run: |
            echo "ðŸ”’ Validating Dockerfile security practices..."
            # Check for non-root user
              if ! grep -q "USER" Dockerfile; then
                echo "âŒ Dockerfile should specify non-root USER"
              exit 1
              fi
          
              # Check for COPY/ADD best practices
              if grep -q "COPY.*\*" Dockerfile; then
                echo "âš ï¸ Avoid using wildcards in COPY commands"
                fi
          
                echo "âœ… Docker security validation passed"

        - name: Environment security check
          run: |
            echo "ðŸ” Checking environment configuration..."
            # Ensure no hardcoded secrets in env files
            if find . -name "*.env*" -not -path "./node_modules/*" -exec grep -l "sk_\|pk_\|secret" {} \; | grep -v ".example"; then
            echo "âŒ Potential secrets found in environment files"
            exit 1
            fi
            echo "âœ… Environment security check passed"

security-report:
  - name: ðŸ“Š Security Report
    runs-on: ubuntu-latest
    needs: [dependency-security, container-security, secrets-scan, compliance-check]
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "ðŸ”’ SECURITY AUDIT SUMMARY"
          echo "========================="
          echo "Date: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "âœ… Dependency Security: ${{ needs.dependency-security.result }}"
          echo "âœ… Container Security: ${{ needs.container-security.result }}"
          echo "âœ… Secrets Detection: ${{ needs.secrets-scan.result }}"
          echo "âœ… Compliance Check: ${{ needs.compliance-check.result }}"
          echo ""
          if [[ "${{ needs.dependency-security.result }}" == "success" && 
                "${{ needs.container-security.result }}" == "success" && 
                "${{ needs.secrets-scan.result }}" == "success" && 
                "${{ needs.compliance-check.result }}" == "success" ]]; then
            echo "ðŸŽ‰ ALL SECURITY CHECKS PASSED"
          else
            echo "ðŸš¨ SECURITY ISSUES DETECTED - REVIEW REQUIRED"
          fi

            vulnerability-audit:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
        fetch-depth: 0
      
      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache Dependencies
        uses: Swatinem/rust-cache@v2
        with:
        key: ${{ runner.os }}-security-audit
        
      - name: Install Security Tools
        run: |
          cargo install cargo-audit --locked
          cargo install cargo-deny --locked
          cargo install cargo-outdated --locked
        
      - name: Run Cargo Audit
        run: |
         echo "ðŸ” Running security vulnerability audit..."
         cargo audit --color=always --deny warnings
         echo "âœ… Security audit completed"
        
      - name: Generate Audit Report
        run: |
         cargo audit --format=json > audit-report.json || true
         cargo audit --format=markdown > audit-report.md || true
         continue-on-error: true
      
      - name: Upload Audit Reports
        uses: actions/upload-artifact@v3
        with:
          name: security-audit-reports
          path: |
           audit-report.json
           audit-report.md
        retention-days: 30
      
        dependency-compliance:
          name: Dependency Compliance
          runs-on: ubuntu-latest
          timeout-minutes: 15
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Rust Toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache Dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: ${{ runner.os }}-dependency-check
        
    - name: Install cargo-deny
      run: cargo install cargo-deny --locked
      
    - name: Create deny.toml if missing
      run: |
        if [ ! -f deny.toml ]; then
          cat > deny.toml << 'EOF'
        [licenses]
        allow = [
          "MIT",
          "Apache-2.0",
          "Apache-2.0 WITH LLVM-exception",
          "BSD-2-Clause",
          "BSD-3-Clause",
          "ISC",
          "Unicode-DFS-2016",
        ]
        deny = [
          "GPL-2.0",
          "GPL-3.0",
          "AGPL-3.0",
        ]
        [bans]
        EOF

