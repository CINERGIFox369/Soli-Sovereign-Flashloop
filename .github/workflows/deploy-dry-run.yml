name: ğŸ§ª Soli Sovereign Flash-Loop - Dry Run Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dry-run'
        type: choice
        options:
        - dry-run
        - staging

env:
  NODE_VERSION: '20'
  REGISTRY_LOGIN_SERVER: "${{ secrets.ACR_NAME }}.azurecr.io"
  IMAGE_NAME: ${{ secrets.ACR_NAME }}.azurecr.io/soli-keeper:20250904202453
  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dry-run' }}
    permissions:
      id-token: write
      contents: read
      
    steps:
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ”‘ Login to Azure Container Registry
        run: az acr login --name ${{ secrets.ACR_NAME }}
        
      - name: âœ… Use Existing Working Image
        run: |
          echo "Using pre-built image: ${{ env.IMAGE_NAME }}"
          echo "This image was built on Sept 4, 2025 and is known to work correctly"
        
      - name: ğŸŒŠ Create Container Apps Environment (if not exists)
        run: |
          # Check if environment exists
          if ! az containerapp env show --name soli-env --resource-group ${{ secrets.RESOURCE_GROUP }} &>/dev/null; then
            echo "Creating Container Apps environment..."
            LAW_ID=$(az monitor log-analytics workspace show --name soli-law --resource-group ${{ secrets.RESOURCE_GROUP }} --query "id" -o tsv)
            az containerapp env create \
              --name soli-env \
              --resource-group ${{ secrets.RESOURCE_GROUP }} \
              --location eastus \
              --logs-workspace-id "$LAW_ID"
          else
            echo "Container Apps environment already exists"
          fi
          
      - name: ğŸš€ Deploy Container App (DRY RUN MODE)
        run: |
          # Delete existing container app to recreate with proper authentication
          if az containerapp show --name soli-keeper-dry --resource-group ${{ secrets.RESOURCE_GROUP }} &>/dev/null; then
            echo "Deleting existing container app to recreate with proper ACR authentication..."
            az containerapp delete \
              --name soli-keeper-dry \
              --resource-group ${{ secrets.RESOURCE_GROUP }} \
              --yes
          fi
          
          echo "Creating new container app in DRY RUN mode..."
          az containerapp create \
            --name soli-keeper-dry \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --environment soli-env \
            --image ${{ env.IMAGE_NAME }} \
            --registry-server ${{ env.REGISTRY_LOGIN_SERVER }} \
            --registry-identity system \
            --cpu 1.0 \
            --memory 2.0Gi \
            --min-replicas 1 \
            --max-replicas 3 \
            --system-assigned \
            --env-vars \
              "DRY_RUN=true" \
              "AZURE_KEY_VAULT_URL=https://soli-mainnet-kv.vault.azure.net/" \
              "NETWORK_ID=42161" \
              "RPC_URL=https://arb1.arbitrum.io/rpc" \
              "MIN_EDGE_BPS=150" \
              "MAX_DAILY_LOSS=100" \
              "AAVE_LOAN_FRACTION=0.01" \
              "CONFIRM_REAL=false"
          
      - name: ğŸ”— Assign Managed Identity to Key Vault
        run: |
          # Get the container app's managed identity
          PRINCIPAL_ID=$(az containerapp show --name soli-keeper-dry --resource-group ${{ secrets.RESOURCE_GROUP }} --query "identity.principalId" -o tsv)
          
          if [ "$PRINCIPAL_ID" != "null" ] && [ -n "$PRINCIPAL_ID" ]; then
            echo "Found managed identity: $PRINCIPAL_ID"
            
            echo "Assigning Key Vault permissions to managed identity..."
            az keyvault set-policy \
              --name soli-mainnet-kv \
              --object-id $PRINCIPAL_ID \
              --secret-permissions get list
              
            echo "âœ… Key Vault permissions assigned"
            
            echo "Attempting to assign ACR pull permissions..."
            if az role assignment create \
              --assignee-object-id $PRINCIPAL_ID \
              --assignee-principal-type ServicePrincipal \
              --role "AcrPull" \
              --scope "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.RESOURCE_GROUP }}/providers/Microsoft.ContainerRegistry/registries/${{ secrets.ACR_NAME }}" 2>/dev/null; then
              echo "âœ… ACR Pull permissions assigned successfully"
            else
              echo "âš ï¸ Could not assign ACR permissions automatically"
              echo "   Please run manually: az role assignment create --assignee $PRINCIPAL_ID --role AcrPull --scope /subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.RESOURCE_GROUP }}/providers/Microsoft.ContainerRegistry/registries/${{ secrets.ACR_NAME }}"
            fi
          else
            echo "âŒ No managed identity found for container app"
          fi
          
      - name: âœ… Deployment Summary
        run: |
          echo "ğŸ‰ Dry Run Deployment Complete!"
          echo "ğŸ“Š Container App: soli-keeper-dry"
          echo "ğŸ”’ Mode: DRY_RUN=true (NO REAL TRADES)"
          echo "ğŸŒ Network: Arbitrum (Chain ID: 42161)"
          echo "ğŸ”‘ Key Vault: soli-mainnet-kv.vault.azure.net"
          echo ""
          
          # Check container app status
          echo "ğŸ“‹ Container App Status:"
          az containerapp show --name soli-keeper-dry --resource-group ${{ secrets.RESOURCE_GROUP }} --query "{status: properties.runningStatus, fqdn: properties.configuration.ingress.fqdn, image: properties.template.containers[0].image}" -o table
          
          echo ""
          echo "ğŸ” Monitor the deployment:"
          echo "az containerapp logs show --name soli-keeper-dry --resource-group ${{ secrets.RESOURCE_GROUP }} --follow"
          echo ""
          echo "âš ï¸  This is a DRY RUN - no real transactions will be executed!"
          echo ""
          echo "ğŸ“ Next Steps:"
          if [ -n "$PRINCIPAL_ID" ]; then
            echo "1. If ACR permissions were not assigned automatically, run:"
            echo "   az role assignment create --assignee $PRINCIPAL_ID --role AcrPull --scope /subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.RESOURCE_GROUP }}/providers/Microsoft.ContainerRegistry/registries/${{ secrets.ACR_NAME }}"
            echo "2. Then restart the container app:"
            echo "   az containerapp revision restart --name soli-keeper-dry --resource-group ${{ secrets.RESOURCE_GROUP }}"
          fi
